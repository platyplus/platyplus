# Roadmap

## MVP

- [ ] Application
  - [x] many to many
    - [x] RxDB 10
    - [x] composite RxDB primary keys
    - [x] read many2many
    - [x] save many2many
  - [x] sync reverse relationships locally
    - [x] one2many
    - [x] many2one
    - [x] many2many
    - [x] check if it works on both insert and update
  - [x] forms: see bug when inserting a visit
  - [x] delete is not working anymore
  - [x] default values
    - [x] form is valid when a required property has a default
      - -> review isRequired(property) - a property can be non-nullable but not required when a default value exists
    - [x] load default values when creating a document
  - [x] form action bar: allow 'save' action when not valid, but trigger form validation
  - [x] complete/fix date & date-time inputs
  - [x] differenciate number and integer inputs
  - [x] basic data validation (by type)
    - [x] implement 'canSave' - and use it in the toolbar
    - [x] according to field type
    - [x] required columns
    - [x] required relationships
  - [x] Move the config action inside the config page
  - [x] order menu
    - [x] create something like an `app_config` table
    - [x] order on the main `config` page
    - [x] save changes
    - [x] pull `table_config` and `property_config` out of metadata documents
    - [x] save `config` stuff through the replicator/modifier
  - [x] useConfigEnabled: config is enabled if user has an admin role
  - [x] default values are not working anymore - see default boolean value in `patient` table
  - rxdb-hasura metadata store
    - [x] useIsMetadataLoading() / useIsMetadataReady()
    - [x] zustand in rxdb-hasura for metadata & config tables
    - [x] directly manage/replicate config, not through metadata (own replicator etc)
      - [x] move the console/graphql way to persist config to the rxdb-hasura/metadata/config folder
    - [x] config pages: avoid providing roles
      - [x] replace `collection.properties` by `getMetadataProperties(metadata: Metadata, ordered: boolean)`
    - [x] impact analysis: break collection.metadata link and use the store instead
  - [x] populate document/collection fields before render - table view is blinking
  - [x] debug
    - [x] create
    - [x] update
      - [x] problem on relationships (form input require the doc key, whereas document properties have been populated)
      - [x] problem on 'deleted' and 'updated_at' field - where to remove them
    - [x] remove
    - [x] real-time form fields - e.g. when editing profile
  - [x] re-activate permissions
  - [x] wait for metadata/config to be loaded before fetching documents from the backend
  - [x] debug and improve profile page
    - [x] `account` links are still here
  - [ ] **Many to Many**
    - [x] rollback old system: no join table in push/pull
      - [x] pull
      - [x] push
      - [x] components
    - [ ] hide from menu
  - [ ] link-reverse relationship hooks
  - [ ] **remove db.contents$ and the related hooks / subscriptions**
  - [ ] **foreign key constraints**
    - [ ] onDelete constraint
      - [x] m2m specific case
      - [ ] cascade
      - [ ] set null - only when columns are nullable - throw error otherwise
      - [ ] restrict - idem
      - [ ] no action - idem
      - [ ] set default - only when default exists or columns are nullable
    - [ ] canSave - only when fk constraints allow it
    - [ ] onUpdate
    - bug on validating form with a required many2one field: is it related?
  - [ ] get rid of useOrderedContentsCollections
  - [ ] label - check if label regenerates when changing its template
  - [ ] **realtime metadata**: generate RxDB migrations automatically when metadata changes (columns, properties, etc)
  - [ ] **improve online/offline mode** (replication, jwt, logout...) both on dev (memory) and prod (indexeddb)
    - [ ] better handling of disconnections / replication errors
    - [ ] PWA
    - [ ] rxdb persistence
- [ ] Hasura 2
  - avoid regressions
  - list missing metadata elements e.g. muliple db, inherited roles...
- [ ] Docker images
  - [ ] GitHub action
  - [ ] Platyplus Hasura (include migrations + schema)
  - [ ] Platyplus Nginx (nx build, GitHub action)
- [ ] Helm Charts
  - [ ] GitHub action
  - [ ] Platyplus
  - [ ] Hasura 2
  - [ ] HBP 2.7
- [ ] Tilt
  - [ ] HBP 2.7: (do not publish - wait until hasura-auth is out)
  - [ ] Hasura 2
- [ ] Documentation
  - [ ] docusaurus
  - [ ] GitHub Action
  - [ ] adjust existing contents
  - [ ] add guide.md
  - [ ] Getting started
    - [ ] Dev
      - [ ] Docker-compose
      - [ ] Tilt
    - [ ] Deploy
      - [ ] Docker-compose
      - [ ] Kubernetes
  - [ ] technical schema on how RxDB starts (auth/jwt, metadata, config, contents...)
- [ ] make everything work with Pulumi
- [ ] squash Hasura migrations

## Then

- Application
  - [ ] handle relationships like rxdb-utils views
  - [ ] multi-role
    - [ ] link-reverse: when a document is modified in a role collection, it must be reflected to other roles...
    - [ ] config module only covers one role - see pages/config/table.tsx
      - [ ] => fetch only one me_metadata table for all roles???
    - [ ] (multi-role bug) push/pull replication: add the current hasura-role to the headers
  - [ ] list Hasura features to be mapped to RxDB e.g.
    - [ ] remote schemas
    - [ ] inherited roles
    - [ ] remote relationships
    - [ ] column presets
  - [ ] nullable values vs default values vs form values
  - [ ] refactor the way to load table/collection/property components
  - [ ] validation rules stored on the backend
    - [ ] Postgres domain e.g. email
    - [ ] number/string min/max
  - [ ] permissions
  - [ ] varchar(x) -> validate string length < x
  - [ ] created_at / created_by
  - [ ] computed values
  - [ ] searchable collections
  - [ ] review indexes in RxDB
  - [ ] add Hasura permissions to create/update/remove permissions
  - [ ] custom menus
    - [ ] for everyone / per role / per user
    - [ ] filtered collections
  - [ ] components
    - [ ] one2one
      - [ ] update sync of reverse relationship
    - [ ] email
    - [ ] time
    - [ ] cards
    - [ ] nested relations
    - [ ] calendar
    - [ ] QR code / codebar scanner
    - [ ] time period (from-to)
    - [ ] charts
    - [ ] maps & PostGIS
      - [ ] point field: location/single dot
      - [ ] collection / many2one: polygon, multiple dots
    - [ ] icon
    - [ ] avatar
    - [ ] rich text / markdown
    - [ ] complete every field component
      - [ ] ipv4 / ipv6
      - [ ] hostname
      - [ ] object
      - [ ] array
      - [ ] uri
    - [ ] singletons
  - Hasura Schema sharing? (https://hasura.io/events/hasura-con-2021/talks/hasura-schema-sharing/)
  - [x] remove useless code in rxdb-hasura (e.g. document.component())
  - [ ] automate required permissions and fields e.g. updated_at, id etc on the backend (to simplify adding tables to the application)
  - [ ] Better integration with HBP e.g. registration, password change, 2fa...
- Charts
  - [ ] Hasura: wait for postrges service to be ready
  - [ ] HBP: wait for hasura service to be ready
  - [ ] clean legacy Helm Charts (artifacthub annotation bug)
  - [ ] Publish chart in awesome Hasura
- [ ] Nx & npm semver
- [ ] online demo(s)?
- [ ] Main website cleanup - remove charts tab and link to artifacthub
- [ ] packages: update README.md

## Next

- Application
  - [ ] map metadata views and tables with camelCase
  - [ ] push only columns that have changed
  - [ ] pagination
  - [ ] internationalisation
  - [ ] conflict resolution
  - [ ] Isomorphic validation
  - [ ] map custom GraphQL names vs PostgreSQL names
  - [ ] encryption
  - [ ] unique columns or sets of columns: tricky. in a hook? don't forget to index. See https://github.com/pubkey/rxdb/issues/728
- Charts
  - [x] Helm Charts repo: keep history (older chart versions) -> chartmuseum
    - [x] platydev cluster
    - [x] terraform: review + publish module
    - [ ] argocd that deploys applications (chartmuseum)
  - [ ] Nx and Helm charts?
  - [ ] Improve Helm Chart production/development values
  - [ ] PostgreSql HA https://github.com/bitnami/charts/tree/master/bitnami/postgresql-ha
- [ ] Custom Express/Koa service
- [ ] in every package.json: add keywords
- [ ] review TODOs in the code

## Later

- [ ] RxDB attachments and hbp storage
- [ ] `values.schema.json` in Helm Charts, and other artifacthub annotations
- [ ] rabbitmq docker, helm & template?
- [ ] hasura init container: wait for postgres
- [ ] hbp init container: wait for hasura (and for minio?)
- [ ] standard init container: wait for connected services
- [ ] move templates to the root folder?
- [ ] vite template -> `serviceTypeConfig.command = "yarn create {{xyz}}"`
- [ ] when fetching HBP metadata/migrations:
  - `git clone --filter` only the required directories
  - copy only sql files of the migrations (Hasura config v1), not the yaml files (Hasura config 1)

## Parked

- [ ] dark/light mode
  - [ ] rsuite next -> when CSS variables are available
  - [ ] from device's defaults
  - [ ] store in localstorage
  - [ ] store in the backend?
- [ ] Solve the PostgreSQL password change problem, e.g. in a pre upgrade hook batch?
  - See: https://github.com/bitnami/charts/issues/2061
- [ ] Include external files (Helm 3.6)
  - Install/upgrade/rollback Hasura migrations
  - Use it for HBP configuration files
  - As a result: remove Hasura & HBP dockerfiles in devtools
  - Then, move helm directory to the project directory?
  - Then, review HBP template and functionning with storage rules embedded in `values.yaml`
  - See: https://github.com/helm/helm/issues/3276
- [ ] Hasura Auth
  - [ ] Helm Chart
  - [ ] Tilt module
