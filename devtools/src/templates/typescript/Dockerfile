# ! ########################################################################### ! #
# ! #|     THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY     |# ! #
# ! ########################################################################### ! #

FROM node:14-alpine as lerna-base
RUN apk add --no-cache jq
RUN npm i lerna -g --loglevel error
USER node
RUN mkdir /home/node/app
WORKDIR /home/node/app

COPY --chown=node:node package.json yarn.* lerna.json ./
#{{#each dependencies}}
COPY --chown=node:node {{this.directory}}/{{this.name}}/package.json {{this.directory}}/{{this.name}}/yarn.* {{this.directory}}/{{this.name}}/
#{{/each}}
COPY --chown=node:node {{directory}}/{{name}}/package.json {{directory}}/{{name}}/yarn.* /home/node/app/{{directory}}/{{name}}/

FROM lerna-base as builder
RUN yarn
COPY --chown=node:node tsconfig.json tsconfig.build.json ./
COPY --chown=node:node types ./types

#{{#each dependencies}}
COPY --chown=node:node {{this.directory}}/{{this.name}} /home/node/app/{{this.directory}}/{{this.name}}
#{{/each}}
COPY --chown=node:node {{directory}}/{{name}} /home/node/app/{{directory}}/{{name}}

RUN lerna run build

FROM lerna-base as dependencies
RUN cat {{directory}}/{{name}}/package.json | jq '. * {workspaces: {nohoist: ["**"]}}' > {{directory}}/{{name}}/package.json
RUN yarn --production --no-optional
RUN tar -cf /home/node/dependencies.tar {{directory}}/{{name}}/node_modules {{directory}}/{{name}}/package.json {{directory}}/{{name}}/yarn.*

FROM node:14-alpine as run
USER node
RUN mkdir /home/node/app
WORKDIR /home/node/app
EXPOSE 3000
COPY --from=dependencies /home/node/dependencies.tar /tmp
RUN tar -xf /tmp/dependencies.tar
COPY --from=builder /home/node/app/{{directory}}/{{name}}/dist /home/node/app/{{directory}}/{{name}}/dist
CMD cd {{directory}}/{{name}} && node dist/index.js

