# ! ########################################################################### ! #
# ! #|     THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY     |# ! #
# ! ########################################################################### ! #

FROM node:14-alpine as lerna-base
RUN apk add --no-cache jq
RUN npm i lerna -g --loglevel error
USER node
RUN mkdir /home/node/app
WORKDIR /home/node/app

COPY --chown=node:node package.json yarn.* lerna.json ./
#
COPY --chown=node:node tilehuria/schema/package.json tilehuria/schema/yarn.* tilehuria/schema/
#
COPY --chown=node:node tilehuria/hooks/package.json tilehuria/hooks/yarn.* /home/node/app/tilehuria/hooks/

FROM lerna-base as builder
RUN yarn
COPY --chown=node:node tsconfig.json tsconfig.build.json ./
COPY --chown=node:node types ./types

#
COPY --chown=node:node tilehuria/schema /home/node/app/tilehuria/schema
#
COPY --chown=node:node tilehuria/hooks /home/node/app/tilehuria/hooks

RUN yarn build

FROM lerna-base as dependencies
RUN ls
RUN ls tilehuria
RUN ls tilehuria/hooks
RUN cat tilehuria/hooks/package.json
RUN cat tilehuria/hooks/package.json | jq '. * {workspaces: {nohoist: ["**"]}}'
RUN cat tilehuria/hooks/package.json | jq '. * {workspaces: {nohoist: ["**"]}}' > tilehuria/hooks/package.json
# RUN yarn cache clean --force && yarn install --production
RUN cat tilehuria/hooks/package.json
RUN yarn install --verbose --production
RUN tar -cf /home/node/dependencies.tar tilehuria/hooks/node_modules tilehuria/hooks/package.json tilehuria/hooks/yarn.*

FROM node:14-alpine as run
USER node
RUN mkdir /home/node/app
WORKDIR /home/node/app
EXPOSE 3000
COPY --from=dependencies /home/node/dependencies.tar /tmp
RUN tar -xf /tmp/dependencies.tar
COPY --from=builder /home/node/app/tilehuria/hooks/dist /home/node/app/tilehuria/hooks/dist
CMD cd tilehuria/hooks && node dist/index.js

